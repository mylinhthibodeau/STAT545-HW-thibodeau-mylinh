---
title: "stat545-hw05-thibodeau-mylinh"
author: "My Linh Thibodeau"
date: '2017-10-14'
output: github_document
---

```{r}
suppressPackageStartupMessages(library(tidyverse))
knitr::opts_chunk$set(fig.width=12, fig.height=9)
library(knitr)
library(kableExtra)
options(knitr.table.format = "html")
library(readr)
library(forcats)
install.packages("gdata")
library(gdata)
#install.packages("tidygenomics") # Not used for now, but perhaps in another homework
#library(tidygenomics) # Not used for now, but perhaps in another homework
```

# Genomic datasets - A few clarifications

Vincenzo Coia has approved my request to use published genomic data for the next assignments, therefore, I want to provide a few clarifications:

* I have tried to introduce some basic explanations about the genomic dataset, but as my objective is to explore and learn how to use R and its packages, not to teach cancer genomic analysis, I am sorry in advance if you are not sure what the data and plots represent, but focus on the data manipulation behind and not what the data represents, and I hope you will still enjoy reading my homework !
* If you have any questions, please don't hesitate to let me know :) 
* Given the size of the data, I only display a few rows per table to keep it readable.

## SOURCES OF DATA: The Cancer Genome Atlas (TCGA) and ClinVar 

Thibodeau, M. L. et al. Genomic profiling of pelvic genital type leiomyosarcoma in a woman with a germline CHEK2:c.1100delC mutation and a concomitant diagnosis of metastatic invasive ductal breast carcinoma. Cold Spring Harb Mol Case Stud mcs.a001628 (2017). doi:10.1101/mcs.a001628  
Open access article and data available [here](http://molecularcasestudies.cshlp.org/content/3/5/a001628.long)  

# Get the data and clean the data

```{r}
chek2_rna_cnv <- read.table("/Users/mylinh/Desktop/chek2-data-trial-stat545/chek2-rna-expression-cnv-data.txt", sep="\t",  strip.white = TRUE, header = TRUE)
View(chek2_rna_cnv) 
# class(chek2_rna_cnv)
# typeof(chek2_rna_cnv)
summary(chek2_rna_cnv) %>% kable("html") %>% kable_styling()
dim(chek2_rna_cnv)
```
**Note 1.** I tried to use the functions from readr (read_table(), read_table2 and read_tsv()), but the column names with spaces (e.g. Ensembl gene ID) were not converted to column names with dot separation like it is done in read.table (E.g. Ensembl gene ID -> Ensembl.gene.ID.), which messed up the full data frame. I had error messages when trying to use dget() and dput. Therefore, why change a functional approach: I decided to keep read.table to do this homework.

Let's clean up the data first:

* Remove the rows for which there is no empty values for these columns: chr, start, end, strand, Ensembl.gene.ID., hugo
* fill the cancer.gene.type empty cells with the mention "NA" 
* remove the duplicate hugo genes

```{r}
chek2_rna_cnv <- with(chek2_rna_cnv, chek2_rna_cnv[!(chr==""),])
chek2_rna_cnv <- with(chek2_rna_cnv, chek2_rna_cnv[!(start==""),])
chek2_rna_cnv <- with(chek2_rna_cnv, chek2_rna_cnv[!(end==""),])
chek2_rna_cnv <- with(chek2_rna_cnv, chek2_rna_cnv[!(Ensembl.gene.ID==""),])
chek2_rna_cnv <- with(chek2_rna_cnv, chek2_rna_cnv[!(hugo==""),])
chek2_rna_cnv$cancer.gene.type <- as.character(chek2_rna_cnv$cancer.gene.type)
chek2_rna_cnv$cancer.gene.type[chek2_rna_cnv$cancer.gene.type==""] <- "NA"
chek2_rna_cnv$cancer.gene.type <- as.factor(chek2_rna_cnv$cancer.gene.type)
gene_types <- levels(chek2_rna_cnv$cancer.gene.type)
chek2_rna_cnv <- chek2_rna_cnv %>%
  group_by(hugo) %>%
  slice(1L)
dim(chek2_rna_cnv)
```
** Note 1.** You might have noticed that I manipulated the cancer.gene.type variable to change it to a character in order to replace the cancer.gene.type empty cells by "NA", then converted back to a factor, which partially answers exercise **(1A)** (see below)

# HOMEWORK REQUIREMENTS

Goals:

1. Reorder a factor in a principled way based on the data and demonstrate the effect in arranged data and in figures.
2. Improve a figure (or make one from scratch), using new knowledge, e.g., control the color scheme, use factor levels, smoother mechanics.
3. Implement visualization design principles.
4. Write some data to file and load it back into R. E.g., save a plot to file and include it in a R Markdown report via ![Alt text](/path/to/img.png).
5. Organise your github, to celebrate the completion of STAT 545 and/or to prepare for the glorious future of STAT 547.

# (1) Reorder a factor in a principled way

**Note 1.** I searched several online dictionaries, and I still do not understand the meaning of "principled": the online dictionaries are giving me answers like ["based on moral rules"](http://dictionary.cambridge.org/dictionary/english/principled) and ["(of a system or method) based on a given set of rules"](https://en.oxforddictionaries.com/definition/principled), so I will conclude that if my approach is coherent and follow a logical path, it is principled.   

## (1A) Factorise

Transform some of the variable of chek2_rna_cnv into factors. In cleaning up the dataset, we converted a factors column into characters then back to factors. 

Let's see what class of data we have in chek2_rna_cnv first. 
```{r}
sapply(chek2_rna_cnv, class) %>% kable("html") %>% kable_styling()
```

Change the avg.TCGA.percentile (class integer) to factors with base R:
```{r}
chek2_rna_cnv$avg.TCGA.percentile <- as.factor(chek2_rna_cnv$avg.TCGA.percentile)
chek2_rna_cnv %>% 
  select(hugo,avg.TCGA.percentile) %>%
  head(10) %>% kable("html") %>% kable_styling()
chek2_rna_cnv$avg.TCGA.percentile %>% head(10) %>% kable("html") %>% kable_styling()
avg.TCGA.percentile_types <- levels(chek2_rna_cnv$avg.TCGA.percentile)
avg.TCGA.percentile_types
length(avg.TCGA.percentile_types)
#avg.TCGA.percentile_types
```

Change the avg.TCGA.percentile (class integer) to factors with forcats:

```{r}
chek2_rna_cnv$avg.TCGA.percentile <- as_factor(chek2_rna_cnv$avg.TCGA.percentile) 
chek2_rna_cnv %>% 
  select(hugo,avg.TCGA.percentile) %>%
  head(10) %>% kable("html") %>% kable_styling()
chek2_rna_cnv$avg.TCGA.percentile %>% head(10) %>% kable("html") %>% kable_styling()
#avg.TCGA.percentile_types <- levels(chek2_rna_cnv$avg.TCGA.percentile)
#avg.TCGA.percentile_types
```

In my case, I obtain the same result with base R and forcats with the avg.TCGA.percentile as factors, although I know that base R has a tendency to try re-ordering the data, which is not alway what we want, but the code syntax I used did not lead to this problem for me. 

## (1B) Drop 0

Filter chek2_rna_cnv to remove all the avg.TCGA.percentile equal to 0 and drop unused levels.

```{r}
length(levels(chek2_rna_cnv$avg.TCGA.percentile))
d1 <- chek2_rna_cnv %>%
  filter(avg.TCGA.percentile != 0) %>%
  arrange(avg.TCGA.percentile) %>%
  select(hugo, avg.TCGA.percentile)

d1 <- data.frame(d1)
# droplevels(d1$avg.TCGA.percentile)
d1 <- drop.levels(d1)
length(levels(d1$avg.TCGA.percentile))
```
**Note 1.** In the example above, you can see that the number of levels is initially 101 (length function) and after removing the avg.TCGA.percentile equal to 0, the number of levels is 100, so I successfully dropped the unused level "0".

**Note 2.** To do this, I used a function of the gdata package, as exemplified  [here](https://www.r-bloggers.com/r-drop-factor-levels-in-a-dataset/)

## (1C) Reorder the levels of year, artist_name or title

Use the forcats package to change the order of the factor levels, based on a principled summary of one of the quantitative variables. Consider experimenting with a summary statistic beyond the most basic choice of the median.

### INITIAL PLOT

I will plot the RPKM value according to each hugo gene.

```{r}
d2 <- chek2_rna_cnv %>%
  filter(avg.TCGA.percentile != 0) %>%
  arrange(avg.TCGA.percentile)

p1 <- d2 %>%
  group_by(hugo) %>%
  arrange(RPKM) %>%
  ggplot(aes(x=hugo, y=RPKM))
p1 + geom_point(aes(colour=cancer.gene.type), alpha = 0.6) + 
  theme(text = element_text(size=12), axis.title.x=element_blank(), axis.text.x = element_blank(), axis.ticks.x=element_blank())
```
**Note 1.** This is not very pretty, I would like to re-order the hugo gene according to their increasing value of RPKM.

### PLOT AFTER ARRANGING BY FACTOR HUGO

BASE R EXAMPLE

I will arrange the order of the factor hugo according to the ascending value of RPKM, as previously exemplified in my [homework 3](https://github.com/mylinhthibodeau/STAT545-HW-thibodeau-mylinh/tree/master/stat545-hw3-thibodeau-mylinh).

```{r}
d2$hugo <- factor(d2$hugo, levels = d2$hugo[order(d2$RPKM)]) 
p1 <- d2 %>%
  group_by(hugo) %>%
  arrange(RPKM) %>%
  filter(cancer.gene.type != "NA") %>%
  ggplot(aes(x=hugo, y=RPKM))
p1 + geom_point(aes(colour=cancer.gene.type), alpha = 0.6) + 
  theme(text = element_text(size=12), axis.title.x=element_blank(), axis.text.x = element_blank(), axis.ticks.x=element_blank())
```

According to a summary value, re-order the cancer.gene.type

```{r}
d3.mean.percentile.by.type <- d3 %>%
  group_by(cancer.gene.type) %>%
  summarize(mean.percentile.by.type = mean(avg.TCGA.percentile, na.rm =TRUE)) %>%
  arrange(mean.percentile.by.type) 
d3.mean.percentile.by.type  %>% kable("html") %>% kable_styling()

p3 <- d3.mean.percentile.by.type %>%
  ggplot(aes(x=cancer.gene.type, y = mean.percentile.by.type))
p3 + geom_point() + theme(text = element_text(size=12), axis.text.x = element_text(angle=45, hjust=1))
        
p3 <- d3.mean.percentile.by.type %>%
  ggplot(aes(x=fct_reorder(cancer.gene.type, mean.percentile.by.type), y = mean.percentile.by.type))
p3 + geom_point() + theme(text = element_text(size=12), axis.text.x = element_text(angle=45, hjust=1))
```

More complicated example - TO REMOVE

Let's change the avg.TCGA.percentile back to a numeric and create a factor column with the expert interpretation (exp_interpret) of the expression level.
```{r}
chek2_rna_cnv$avg.TCGA.percentile <- as.numeric(chek2_rna_cnv$avg.TCGA.percentile) 
class(chek2_rna_cnv$avg.TCGA.percentile)
d3 <- chek2_rna_cnv %>%
  filter(avg.TCGA.percentile != 0) %>%
  arrange(avg.TCGA.percentile)


```

Resources: stack overflow example for cut 
[here](https://stackoverflow.com/questions/40380112/categorize-continuous-variable-with-dplyr), examples of forcats [here](https://blog.rstudio.com/2016/08/31/forcats-0-1-0/) 

Very useful from stat545 [here](http://stat545.com/block029_factors.html)

FORCATS EXAMPLE

```{r}

```


## (1D) Characterize the (derived) data before and after your factor re-leveling.

* Explore the effects of arrange(). Does merely arranging the data have any effect on, say, a figure?
* Explore the effects of reordering a factor and factor reordering coupled with arrange(). Especially, what effect does this have on a figure?

These explorations should involve the data, the factor levels, and some figures.



Resources: 
[tidyverse and readr](https://github.com/tidyverse/readr/issues)

# (2) Improve a figure


# (3) Implement visualization design principles


# (4) File I/O: write some data to file and load it back into R, explore functions for reading an input file and writing to an output file



# (5) Organise your github
