---
title: "mut_sig_plot"
author: "My Linh Thibodeau"
date: '2017-11-11'
output: html_document
---

```{r, echo = FALSE}
setwd("~/Desktop/STAT545-HW-thibodeau-mylinh/stat547-hw7-thibodeau-mylinh/")
suppressMessages(suppressWarnings(library(tidyverse)))
suppressMessages(suppressWarnings(knitr::opts_chunk$set(fig.width=13, fig.height=8)))
suppressMessages(suppressWarnings(library(ggpmisc)))
suppressMessages(suppressWarnings(library(nnls)))
library(devtools)
suppressMessages(suppressWarnings(library(forcats)))
library(ggthemes)
library(grid)
mut_sig <- read.table("mut_sig.tsv", header = TRUE, sep = "\t")
ref_mut_sig_ordered_by_sig3 <- readRDS("ref_mut_sig_ordered_by_sig3.rds")
mut_sig_gather <- read.table("mut_sig_gather.tsv", header = TRUE, sep="\t")
ALL_mut_gather <- read.table("somatic_mutations_formated_files/ALL_mut_gather.tsv", header = TRUE, sep = "\t")
aml_mut_gather <- read.table("somatic_mutations_formated_files/aml_mut_gather.tsv", header = TRUE, sep = "\t")
breast_mut_gather <- read.table("somatic_mutations_formated_files/breast_mut_gather.tsv", header = TRUE, sep = "\t")
medullo_mut_gather <- read.table("somatic_mutations_formated_files/medulloblastoma_mut_gather.tsv", header = TRUE, sep = "\t")
pancreas_mut_gather <- read.table("somatic_mutations_formated_files/pancreas_mut_gather.tsv", header = TRUE, sep = "\t")
all_cancer_types_mut <- read.table("somatic_mutations_formated_files/all_cancer_types_mut.tsv", header = TRUE, sep = "\t")
all_cancer_types_mut_with_ref_sig <- read.table("somatic_mutations_formated_files/all_cancer_types_mut_with_ref_sig.tsv", sep = "\t", header = TRUE)
all_cancer_types_mut_proportion_signatures <- read.table("somatic_mutations_formated_files/all_cancer_types_mut_proportion_signatures.tsv", header = TRUE, sep = "\t")
```

Note. The multiplot_function was taken from the R cookbook [here](http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/).

```{r multiplot_function, echo=FALSE}
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
	require(grid)
	
	# Make a list from the ... arguments and plotlist
	plots <- c(list(...), plotlist)
	
	numPlots = length(plots)
	
	# If layout is NULL, then use 'cols' to determine layout
	if (is.null(layout)) {
		# Make the panel
		# ncol: Number of columns of plots
		# nrow: Number of rows needed, calculated from # of cols
		layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
			ncol = cols, nrow = ceiling(numPlots/cols))
	}
	
	if (numPlots==1) {
		print(plots[[1]])
		
	} else {
		# Set up the page
		grid.newpage()
		pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
		
		# Make each plot, in the correct location
		for (i in 1:numPlots) {
			# Get the i,j matrix positions of the regions that contain this subplot
			matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
			
			print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
				layout.pos.col = matchidx$col))
		}
	}
}

```

# PLOT

## Plot 1

```{r}
Signature3_plot_unordered <- mut_sig %>%
	group_by(Somatic.Mutation.Type) %>%
	ggplot(aes(x=Somatic.Mutation.Type, y=Signature.3)) +
	ggtitle("Unordered Somatic.Mutation.Type according to Signature.3 score") +
	geom_point(aes(size = Signature.12)) + theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=8), axis.text.x = element_text(angle=45, hjust=1))
Signature3_plot <- ref_mut_sig_ordered_by_sig3 %>%
	group_by(Somatic.Mutation.Type) %>%
	ggplot(aes(x=Somatic.Mutation.Type, y=Signature.3)) +
	ggtitle("Ordered Somatic.Mutation.Type according to Signature.3 score") +
	geom_point(aes(size = Signature.12)) + theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=8), axis.text.x = element_text(angle=45, hjust=1))
pdf("plots/Signature3_compare_plots.pdf", width = 13, height = 7)
multiplot(Signature3_plot_unordered, Signature3_plot) 
dev.off()
```

Note. I was able to save the output of the multiplot function to a pdf file based on the suggestion of this Stackoverflow discussion [here](https://stackoverflow.com/questions/11721401/r-save-multiplot-to-file).

# Ploting data from the reference table of somatic signatures

## Plot 2

```{r}
mut_sig_facet <- mut_sig_gather %>%
	group_by(Signature) %>%
	ggplot(aes(x=Somatic.Mutation.Type, y=Score)) + 
	geom_point(aes(color=Score)) +
	scale_colour_gradient(low="blue", high="red") +
	facet_wrap(~Signature) +
	ggtitle("Mutation scores according to Somatic.Mutation.Type and panel according to Signature type") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=12), axis.text.x = element_blank(), 
    axis.ticks.x=element_blank(),
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/mutation_scores_for_all_snv_facet_signature.pdf", mut_sig_facet, width = 16, height =12) 
```

## Plot 3

```{r}
mut_sig_sub <- mut_sig_gather %>%
	group_by(Substitution.Type) %>%
	ggplot(aes(x=Somatic.Mutation.Type, y=Score)) +
	geom_point(aes(color=Substitution.Type)) +
	ggtitle("Mutation scores according to individual signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=12), axis.text.x = element_blank(), 
    axis.ticks.x=element_blank(),
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA)) +
	facet_wrap(~Signature) 
ggsave("plots/mutation_scores_for_all_snv_type_facet_signature_colored_snv.pdf", mut_sig_sub, width = 10, height =6) 
```

# Ploting data from specific cancer types and their somatic mutations

## Plot ALL

Note. There is only one case_id in this dataset, so it doesn't make for a very interesting plot. We will focus on the 4 other datasets in this homework.
```{r}
ALL_mut_p1 <- ALL_mut_gather %>%
	#group_by(case_id) %>%
	ggplot(aes(x=Mutation.Type, y=number)) +
	geom_point(aes(colour=case_id)) +
	ggtitle("Acute lymphoid leukemia - Number of mutations per signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=10), axis.text.x = element_text(angle=45, hjust=1), 
    axis.ticks.x=element_blank(), 
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/ALL_mut_p1.pdf", ALL_mut_p1 , width = 18, height =8)
```

## Plot aml

```{r}
aml_mut_p1 <- aml_mut_gather %>%
	#group_by(case_id) %>%
	ggplot(aes(x=Mutation.Type, y=number)) +
	geom_point(aes(colour=case_id)) +
	ggtitle("Acute myeloid leukemia - Number of mutations per signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=10), axis.text.x = element_text(angle=45, hjust=1), 
    axis.ticks.x=element_blank(), 
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/aml_mut_p1.pdf", aml_mut_p1 , width = 18, height =8)
```

## Plot breast cancer

```{r}
breast_mut_p1 <- breast_mut_gather %>%
	#group_by(case_id) %>%
	ggplot(aes(x=Mutation.Type, y=number)) +
	geom_point(aes(colour=case_id)) +
	ggtitle("Breast cancer - Number of mutations per signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=10), axis.text.x = element_text(angle=45, hjust=1), 
    axis.ticks.x=element_blank(), 
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/breast_mut_p1.pdf", breast_mut_p1,  width = 18, height =8)
```

## Plot medulloblastoma cancer

```{r}
medullo_mut_p1 <- medullo_mut_gather %>%
	#group_by(case_id) %>%
	ggplot(aes(x=Mutation.Type, y=number)) +
	geom_point(aes(colour=case_id)) +
	ggtitle("Medulloblastoma - Number of mutations per signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=10), axis.text.x = element_text(angle=45, hjust=1), 
    axis.ticks.x=element_blank(), 
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/medullo_mut_p1.pdf", medullo_mut_p1 , width = 18, height =8)
```

## Plot pancreas cancer

```{r}
pancreas_mut_p1 <- pancreas_mut_gather %>%
	#group_by(case_id) %>%
	ggplot(aes(x=Mutation.Type, y=number)) +
	geom_point(aes(colour=case_id)) +
	ggtitle("Pancreas cancer - Number of mutations per signatures") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
  text = element_text(size=10), axis.text.x = element_text(angle=45, hjust=1), 
    axis.ticks.x=element_blank(), 
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
ggsave("plots/pancreas_mut_p1.pdf", pancreas_mut_p1 , width = 18, height = 8)
```

## Plot - multiplot

```{r}
pdf("plots/cancer_type_sig_compare_plots.pdf", width = 30, height = 22)
multiplot(ALL_mut_p1, aml_mut_p1, breast_mut_p1, medullo_mut_p1, pancreas_mut_p1) 
dev.off()
```

# Note. I have joined the datasets with the mut_sig_tables.R script to perform some group analysis.

## Plot - take a peak at different cancer type

```{r}
pdf("plots/all_cancer_types_mut_geompoint.pdf", width = 13, height = 9)
all_cancer_types_mut %>%
	group_by(cancer_type) %>%
	ggplot(aes(x=Mutation.Type, y = number)) +
	geom_point(aes(colour=cancer_type), shape=21, alpha = 0.8) +
	ggtitle("Number of mutations according to individual Mutation.Type") + 
	theme(
  plot.title= element_text(color = "grey44", size=24, face="bold"),
		text = element_text(size=10),
		axis.text.x = element_text(angle=45, hjust=1),
    	axis.ticks.x=element_blank(),
		panel.background = element_rect(fill = "white"),
		panel.border = element_rect(fill=NA))
dev.off()
```

# presenting some data (to remove?)

```{r}
all_cancer_types_mut_with_ref_sig_fraction <- all_cancer_types_mut_with_ref_sig %>%
	group_by(case_id) %>%
	mutate(fraction_contribution_per_mutation_type = number/(sum(number)))
View(all_cancer_types_mut_with_ref_sig_fraction)
```


```{r}
all_cancer_types_mut_with_ref_sig %>%
	group_by(Mutation.Type) %>%
	mutate(mean_mutation_type = mean(number)) %>% head()
```

# Linear regression plots

Let's just carry some analyses on the aml (acute myeloid leukemia) datasets to start with.
```{r}
formula <- y ~ x
#View(all_cancer_types_mut_with_ref_sig)
p1_linear <- all_cancer_types_mut_with_ref_sig %>%
	filter(cancer_type == "aml") %>%
	group_by(Mutation.Type) %>%
	ggplot(aes(x=Signature.3, y=number)) +
	geom_point(aes(colour = case_id), shape = 21, alpha = 0.8) +
	facet_wrap(~Substitution.Type) +
	stat_smooth(method="lm", se = FALSE, color="black", formula = formula) +
	stat_poly_eq(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), label.x.npc = "left",
               formula = formula, parse = TRUE, size = 3,
               geom="label")
ggsave("plots/p1_linear_Sig3_aml_mutations.pdf", p1_linear , width = 18, height = 8) 
```

```{r}
#View(all_cancer_types_mut_with_ref_sig)
p2_linear <- all_cancer_types_mut_with_ref_sig %>%
	#filter(cancer_type == "aml") %>%
	group_by(cancer_type, Mutation.Type) %>%
	ggplot(aes(x=Signature.3, y=number)) +
	geom_point(aes(colour = Substitution.Type), shape = 21, alpha = 0.8) +
	facet_wrap(~cancer_type) +
	stat_smooth(method="lm", se = FALSE, color="black", formula = formula) +
	stat_poly_eq(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), label.x.npc = "left",
               formula = formula, parse = TRUE, size = 3,
               geom="label")
ggsave("plots/p2_linear_Sig3_all_cancer_mutations.pdf", p2_linear , width = 18, height = 8) 
```

```{r}
p3_linear <- mut_sig %>%
	ggplot(aes(x=Signature.3, y = Signature.12)) +
	geom_point(aes(colour = Substitution.Type)) +
	stat_smooth(method="lm", se = FALSE, color="black", formula = formula) +
	stat_poly_eq(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), label.x.npc = "left",
               formula = formula, parse = TRUE, size = 3,
               geom="label")
ggsave("plots/p3_linear_Sig3_Sig12.pdf", p3_linear , width = 18, height = 8) 	
```
Note.1. It looks like the T>C somatic mutation group is the one differing the most between Signature.3 and Signature.12, but otherwise, these two signatures could fit "relatively well" a linear regression model (although this is obviously not the best model for this type of data, because the adjusted R-squared value is below zero = the model does not fit the data very well).

Note.2. The code and format used above to add a label with the linear regression formula used the following references:

* A stack overflow discussion on [Regression equation](https://stackoverflow.com/questions/37494969/ggplot2-add-regression-equations-and-r2-and-adjust-their-positions-on-plot)
* The stack overflow discussion on [Label position](https://stackoverflow.com/questions/37254279/dynamic-label-position-stat-poly-eq-and-ggplot2) discussion was also useful.      
* This article of the [cran rstudio website](https://cran.rstudio.com/web/packages/ggpmisc/vignettes/user-guide-1.html) was also used.

```{r}
lm(Signature.12 ~ Signature.3, mut_sig) %>% coef()
```
Note. We obtain the same Intercept and Signature.3 coefficient than in our plot (see label formula).

Just for fun, I want to check if a linear regression would be a better fit if I remove the Substitution.Type T>C.
```{r}
formula <- y ~ x
p4_linear <- mut_sig %>%
	filter(Substitution.Type != "T>C") %>%
	ggplot(aes(x=Signature.3, y = Signature.12)) +
	geom_point(aes(colour = Substitution.Type)) +
	stat_smooth(method="lm", se = FALSE, color="black", formula = formula) +
	stat_poly_eq(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), label.x.npc = "left",
               formula = formula, parse = TRUE, size = 3,
               geom="label")
ggsave("plots/p4_linear_Sig3_Sig12_no_T_C.pdf", p4_linear , width = 18, height = 8) 
```
Note. It does seem like the most different values between these two signatures are the T>C Substitution.Type, as our new adjusted R-squared tells us that 15% of the variance of Signature.12 can be explained by Signature.3 if we remove T>C.

***

Now, let's assess the linear regression model between Signature.2 and Signature.13.

```{r}
formula <- y ~ x
p5_linear <- mut_sig %>%
	ggplot(aes(x=Signature.2, y = Signature.13)) +
	geom_point(aes(colour = Substitution.Type)) +
	stat_smooth(method="lm", se = FALSE, color="black", formula = formula) +
	stat_poly_eq(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), label.x.npc = "left",
               formula = formula, parse = TRUE, size = 3,
               geom="label")
ggsave("plots/p5_linear_Sig2_Sig13.pdf", p5_linear , width = 18, height = 8) 
```
Note. We do get a very high adjusted R-squared value, and this is because these two signatures are thought to be related to the same underlying mutational processes (see [here](http://cancer.sanger.ac.uk/cosmic/signatures) for more details on mutational signatures). Therefore, we can deduce that the Mutation.Type profiles of Signature.2 and Signature.13 are quite similar.

***

# SOME STATISTICAL ANALYSIS (to remove/move to stat file)

```{r}
#View(all_cancer_types_mut_proportion_signatures_mean)
all_cancer_types_signature_contribution <- all_cancer_types_mut_proportion_signatures_mean %>% 
	ungroup() %>%
	group_by(case_id) %>%
	mutate(all_mut_per_case_id = sum(proportion_number_each_sig)) %>%
	ungroup() %>%
	group_by(case_id, Signature) %>%
	mutate(total_mutation_per_signature_fraction = sum(proportion_number_each_sig)/all_mut_per_case_id) %>%
	select(Signature, cancer_type, total_mutation_per_signature_fraction) %>% 
	unique() %>% arrange(case_id)
#View(all_cancer_types_signature_contribution)
```

Let's see the cases with the lowest and highest Signature.3 contribution to their mutational burden.
```{r}
all_cancer_types_signature_contribution %>% 
	group_by(case_id) %>% 
	filter(Signature=="Signature.3") %>%
	arrange(total_mutation_per_signature_fraction) %>%
	head(3) 
all_cancer_types_signature_contribution %>% 
	group_by(case_id) %>% 
	filter(Signature=="Signature.3") %>%
	arrange(desc(total_mutation_per_signature_fraction)) %>%
	head(3)
```
Note. Interestingly, the 3 lowest cases of Signature.3 contribution are all medulloblastoma cases, and the 3 highest a	re all breast cancer cases. There seems to be a cancer_type effect regarding diverse mutational signatures contribution.

What are the highest Signature contributors to mutational burden for diverse cancer types?
```{r}
all_cancer_types_signature_contribution %>%
	ungroup() %>%
	group_by(cancer_type, Signature) %>%
		summarize(max_signatures = max(total_mutation_per_signature_fraction)) %>%
	group_by(Signature, max_signatures) %>%
	arrange(desc(max_signatures), Signature, cancer_type) %>% head(12)
```

